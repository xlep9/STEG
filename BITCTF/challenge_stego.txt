D∆∞·ªõi ƒë√¢y l√† m·ªôt **writeup ho√†n ch·ªânh** cho b√†i `challenge_stego.tif`, vi·∫øt theo ki·ªÉu d·ªÖ hi·ªÉu t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi (ng∆∞·ªùi m·ªõi c≈©ng theo ƒë∆∞·ª£c).

---

# Writeup `challenge_stego.tif` (Stego TIFF + decoy QR)

## K·∫øt qu·∫£ cu·ªëi

* **QR nh√¨n th·∫•y ƒë∆∞·ª£c (m·ªìi nh·ª≠):** `BITSCTF{blud_REALLY_ thought_lmao}` ‚ùå
* **Flag ƒë√∫ng:** `BITSCTF{qr_bu7_n07_7h47_qr}` ‚úÖ

---

## √ù t∆∞·ªüng ch√≠nh c·ªßa b√†i

B√†i n√†y c√≥ **2 l·ªõp**:

1. **L·ªõp d·ªÖ nh√¨n th·∫•y:** m·ªôt m√£ QR (decode ra flag gi·∫£)
2. **L·ªõp ·∫©n th·∫≠t:** d·ªØ li·ªáu gi·∫•u trong ph·∫ßn **sai s·ªë nh·ªè** c·ªßa ·∫£nh TIFF ki·ªÉu `float64`

N√≥i ƒë∆°n gi·∫£n:

* ·∫¢nh hi·ªÉn th·ªã cho b·∫°n th·∫•y QR
* Nh∆∞ng t√°c gi·∫£ c√≤n nh√©t th√™m d·ªØ li·ªáu v√†o ph·∫ßn ‚Äúl·∫ª r·∫•t nh·ªè‚Äù c·ªßa t·ª´ng pixel
* Mu·ªën l·∫•y flag th·∫≠t ph·∫£i ph√¢n t√≠ch ph·∫ßn ƒë√≥

---

# 1) Nh·∫≠n di·ªán file ban ƒë·∫ßu

## B∆∞·ªõc ƒë·∫ßu ti√™n m√¨nh lu√¥n l√†m

```bash
file challenge_stego.tif
```

K·∫øt qu·∫£ (√Ω ch√≠nh):

* ƒê√¢y l√† **TIFF**
* V√† l√† ki·ªÉu **grayscale float64** (·∫£nh x√°m, m·ªói pixel l√† s·ªë th·ª±c 64-bit)

### V√¨ sao ƒëi·ªÅu n√†y quan tr·ªçng?

·∫¢nh b√¨nh th∆∞·ªùng (PNG/JPG) th∆∞·ªùng l∆∞u pixel ki·ªÉu 8-bit (0..255).
`float64` l√† ki·ªÉu **h∆°i l·∫°** trong CTF, r·∫•t ƒë√°ng nghi v√¨ c√≥ th·ªÉ:

* pixel nh√¨n th√¨ gi·ªëng ·∫£nh b√¨nh th∆∞·ªùng
* nh∆∞ng ph·∫ßn s·ªë th·ª±c (decimal) c√≥ th·ªÉ ch·ª©a d·ªØ li·ªáu ·∫©n

---

# 2) Th·ª≠ x·ª≠ l√Ω ·∫£nh nh∆∞ ·∫£nh th∆∞·ªùng (ƒë·ªÉ xem c√≥ g√¨ hi·ªán ra)
c√≥ th·ªÉ d√πng tool m·ªü file tiff tr√™n m·∫°ng ho·∫∑c  
V√¨ l√† TIFF float, nhi·ªÅu ph·∫ßn m·ªÅm kh√¥ng qu√©t QR tr·ª±c ti·∫øp t·ªët. Ta convert v·ªÅ ·∫£nh ƒëen tr·∫Øng:

```bash
convert challenge_stego.tif -auto-level -threshold 50% out.png
convert out.png -bordercolor white -border 20 out_qr.png
```

Sau ƒë√≥ qu√©t QR:

* b·∫±ng ƒëi·ªán tho·∫°i, ho·∫∑c
* b·∫±ng `zbarimg out_qr.png`

## K·∫øt qu·∫£ qu√©t ra

```text
BITSCTF{blud_REALLY_ thought_lmao}
```

---

# 3) V√¨ sao chu·ªói QR n√†y l√† flag gi·∫£?

B·∫°n ƒë√£ th·ª≠ submit v√† **sai**. ƒê√¢y l√† d·∫•u hi·ªáu r·∫•t m·∫°nh cho th·∫•y:

* QR ch·ªâ l√† **decoy** (m·ªìi nh·ª≠)
* c√≤n **m·ªôt l·ªõp stego n·ªØa** trong file TIFF

V√† v√¨ file l√† `float64`, h∆∞·ªõng h·ª£p l√Ω nh·∫•t l√†:

> ki·ªÉm tra **ph·∫ßn gi√° tr·ªã pixel ·∫©n** (kh√¥ng ph·∫£i ch·ªâ ph·∫ßn ƒëen/tr·∫Øng hi·ªán ra)

---

# 4) Hi·ªÉu b·∫£n ch·∫•t ·∫£nh TIFF n√†y (r·∫•t quan tr·ªçng)

## C√°ch t√°c gi·∫£ gi·∫•u d·ªØ li·ªáu

M·ªói pixel trong ·∫£nh g·∫ßn nh∆∞ l√†:

* kho·∫£ng `0.xxxx` (ƒëen)
* ho·∫∑c `255.xxxx` (tr·∫Øng)

Ph·∫ßn:

* `0` ho·∫∑c `255` ‚Üí t·∫°o ra QR m√† m·∫Øt nh√¨n th·∫•y
* ph·∫ßn `.xxxx` (sai s·ªë nh·ªè) ‚Üí d√πng ƒë·ªÉ gi·∫•u d·ªØ li·ªáu th·∫≠t

### H√¨nh dung d·ªÖ hi·ªÉu

Gi·ªëng nh∆∞ t√°c gi·∫£ vi·∫øt QR b·∫±ng b√∫t d·∫° to,
r·ªìi **kh·∫Øc th√™m ch·ªØ nh·ªè li ti** l√™n t·ª´ng √¥ vu√¥ng b·∫±ng b√∫t ch√¨.

M·∫Øt th∆∞·ªùng ch·ªâ th·∫•y QR. Mu·ªën th·∫•y ch·ªØ nh·ªè ph·∫£i t√°ch ph·∫ßn ‚Äúb√∫t ch√¨‚Äù ra.

---

# 5) T√°ch l·ªõp QR ra kh·ªèi ·∫£nh ƒë·ªÉ l·∫•y ‚Äúph·∫ßn ·∫©n‚Äù

Ta l√†m nh∆∞ sau:

1. T·∫°o ·∫£nh QR ‚Äúchu·∫©n‚Äù t·ª´ TIFF (ch·ªâ c√≤n 0 ho·∫∑c 255)
2. L·∫•y:

   ```text
   residual = ·∫£nh g·ªëc - ·∫£nh QR chu·∫©n
   ```
3. `residual` ch√≠nh l√† ph·∫ßn nhi·ªÖu/sai s·ªë ‚Üí n∆°i d·ªØ li·ªáu ·∫©n n·∫±m

---

# 6) Script Python ƒë·ªÉ tr√≠ch l·ªõp ·∫©n (c√°ch m√¨nh l√†m)

## C√†i th∆∞ vi·ªán (n·∫øu c·∫ßn)

```bash
pip install tifffile opencv-python numpy
```

## Script ph√¢n t√≠ch

```python
import tifffile
import numpy as np
import cv2

# ƒê·ªçc TIFF float64
a = tifffile.imread("challenge_stego.tif")
print("shape:", a.shape, "dtype:", a.dtype, "min:", a.min(), "max:", a.max())

# 1) T·∫°o l·ªõp QR "th√¥" (0 ho·∫∑c 255)
base = np.where(a > 127.5, 255.0, 0.0)

# 2) T√°ch ph·∫ßn nhi·ªÖu ·∫©n
res = a - base

# 3) L·∫•y d·∫•u c·ªßa residual (√¢m/d∆∞∆°ng) ƒë·ªÉ nh√¨n th√†nh ·∫£nh nh·ªã ph√¢n
#    >0 -> tr·∫Øng, <=0 -> ƒëen
sign = (res > 0).astype(np.uint8) * 255
cv2.imwrite("hidden_raw.png", sign)

# 4) TƒÉng kh·∫£ nƒÉng ƒë·ªçc: gom h√†ng theo chu k·ª≥ (period) 128
#    (v√¨ d·ªØ li·ªáu ·∫©n l·∫∑p theo h√†ng)
m = sign.astype(np.float32)
m -= m.mean(axis=1, keepdims=True)

P = 128
fold = np.zeros((P, m.shape[1]), np.float32)
cnt = np.zeros((P, 1), np.float32)

for y in range(m.shape[0]):
    fold[y % P] += m[y]
    cnt[y % P] += 1

fold /= cnt

# Chu·∫©n h√≥a ƒë·ªÉ l∆∞u ·∫£nh d·ªÖ nh√¨n
mn, mx = fold.min(), fold.max()
vis = ((fold - mn) / (mx - mn) * 255).astype(np.uint8)

cv2.imwrite("hidden_fold.png", vis)
print("[+] Saved hidden_raw.png and hidden_fold.png")
```

---

# 7) ƒêi·ªÅu g√¨ x·∫£y ra sau khi ch·∫°y script?

B·∫°n s·∫Ω c√≥ 2 ·∫£nh:

## `hidden_raw.png`

* Th·∫•y d·∫•u hi·ªáu ch·ªØ/hoa vƒÉn m·ªù m·ªù
* Ch∆∞a ƒë·ªçc r√µ

## `hidden_fold.png`

* Sau khi ‚Äúg·∫•p‚Äù (fold) theo chu k·ª≥ 128 h√†ng
* Ch·ªØ s·∫Ω r√µ h∆°n nhi·ªÅu
* ƒê·ªçc ra ƒë∆∞·ª£c **flag th·∫≠t**

### Flag th·∫≠t ƒë·ªçc ƒë∆∞·ª£c l√†

```text
BITSCTF{qr_bu7_n07_7h47_qr}
```

---

# 8) T·∫°i sao ph·∫£i ‚Äúfold theo chu k·ª≥ 128‚Äù?

ƒê√¢y l√† m·∫πo x·ª≠ l√Ω ·∫£nh ·∫©n:

* D·ªØ li·ªáu ·∫©n ƒë∆∞·ª£c l·∫∑p l·∫°i theo c√°c h√†ng
* Khi ‚Äúg·∫•p‚Äù ·∫£nh theo chu k·ª≥ `P` (·ªü ƒë√¢y l√† 128), c√°c h√†ng c√πng v·ªã tr√≠ ch·ªìng l√™n nhau
* N·∫øu c√≥ pattern l·∫∑p, n√≥ s·∫Ω **n·ªïi r√µ l√™n**
* Nhi·ªÖu ng·∫´u nhi√™n s·∫Ω b·ªã tri·ªát b·ªõt

### Hi·ªÉu nh∆∞ th·∫ø n√†y

B·∫°n c√≥ nhi·ªÅu b·∫£n ch·ªØ m·ªù ch·ªìng l·ªách nhau.
X·∫øp ƒë√∫ng v·ªã tr√≠ r·ªìi c·ªông l·∫°i ‚Üí ch·ªØ n√©t h∆°n.

---

# 9) N·∫øu ch∆∞a bi·∫øt chu k·ª≥ 128 th√¨ l√†m sao?

C√¢u h·ªèi hay üëå
N·∫øu ch∆∞a bi·∫øt `P = 128`, c√≥ th·ªÉ th·ª≠:

* 32
* 64
* 128
* 256

Trong nhi·ªÅu b√†i CTF, c√°c chu k·ª≥ ki·ªÉu n√†y r·∫•t hay g·∫∑p.

Ho·∫∑c nh√¨n ·∫£nh `hidden_raw.png`, b·∫°n s·∫Ω th·∫•y pattern l·∫∑p theo h√†ng ‚Üí ƒëo√°n c√≥ chu k·ª≥.

---

# 10) T√≥m t·∫Øt quy tr√¨nh gi·∫£i (ng·∫Øn g·ªçn)

## Quy tr√¨nh th·ª±c chi·∫øn

1. `file` ‚Üí nh·∫≠n ra TIFF float64 (ƒë√°ng nghi)
2. Convert ·∫£nh ‚Üí th·∫•y QR
3. Qu√©t QR ‚Üí ra ‚Äúflag‚Äù nh∆∞ng submit sai (decoy)
4. Nghi c√≤n l·ªõp ·∫©n v√¨ file l√† stego TIFF float
5. T√°ch ph·∫ßn QR th√¥ (0/255)
6. L·∫•y `residual = original - base`
7. Xem d·∫•u residual (`res > 0`)
8. Fold theo chu k·ª≥ 128 ƒë·ªÉ l√†m r√µ ch·ªØ
9. ƒê·ªçc flag th·∫≠t

---

# 11) V√¨ sao b√†i n√†y hay?

B√†i n√†y d·∫°y 3 th·ª© r·∫•t quan tr·ªçng trong stego:

## 1) ƒê·ª´ng tin k·∫øt qu·∫£ ƒë·∫ßu ti√™n

Ra QR ch∆∞a ch·∫Øc l√† xong.
N·∫øu challenge t√™n `stego`, lu√¥n nghƒ©: ‚Äúc√≤n l·ªõp n·ªØa kh√¥ng?‚Äù

## 2) ƒê·ªãnh d·∫°ng file r·∫•t quan tr·ªçng

`TIFF float64` l√† clue l·ªõn.
N·∫øu l√† ·∫£nh 8-bit b√¨nh th∆∞·ªùng th√¨ √≠t ai l√†m ki·ªÉu residual n√†y.

## 3) Stego kh√¥ng ch·ªâ l√† LSB

B·∫°n ƒë√£ l√†m b√†i LSB (`smoke.png`) r·ªìi.
B√†i n√†y l√† ki·ªÉu kh√°c: gi·∫•u trong **gi√° tr·ªã float / nhi·ªÖu nh·ªè**.

---

# 12) Cheat sheet nh·ªè cho c√°c b√†i ·∫£nh stego sau n√†y

## Khi g·∫∑p ·∫£nh l·∫°, th·ª≠ theo th·ª© t·ª±:

```bash
file <file>
exiftool <file>
strings -n 6 <file>
binwalk <file>
```

## N·∫øu l√† PNG/BMP:

* `zsteg -a file.png`
* Stegsolve (bit planes)

## N·∫øu l√† JPG:

* `binwalk`
* `steghide`, `outguess`, metadata

## N·∫øu l√† TIFF / ·∫£nh khoa h·ªçc / float:

* D√πng Python (`tifffile`, `numpy`)
* Ki·ªÉm tra:

  * dtype (`float64`?)
  * min/max
  * residual
  * sign / bitplanes / threshold

---

# 13) K·∫øt lu·∫≠n cu·ªëi (r·∫•t d·ªÖ nh·ªõ)

* **QR b·∫°n qu√©t ƒë∆∞·ª£c l√† m·ªìi nh·ª≠**
* **Flag th·∫≠t n·∫±m trong ph·∫ßn nhi·ªÖu nh·ªè c·ªßa ·∫£nh TIFF float**
* C√°ch l·∫•y l√†:

  * t√°ch l·ªõp QR
  * l·∫•y residual
  * chuy·ªÉn sign th√†nh ·∫£nh
  * fold theo chu k·ª≥ ƒë·ªÉ ƒë·ªçc text

‚úÖ **Flag ƒë√∫ng:** `BITSCTF{qr_bu7_n07_7h47_qr}`


